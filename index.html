<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Image Tracking - Dragonite</title>
    
    <!-- import aframe and then ar.js with image tracking / location based features -->
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <!-- Gesture detector for touch controls -->
    <script src="https://raw.githack.com/fcor/arjs-gestures/master/dist/gestures.js"></script>

    <!-- style for the loader -->
    <style>
        /* Ensure a-scene fits the viewport */
        a-scene {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Ensure video element fits the viewport */
        
        a-scene canvas {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            object-fit: cover !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        video{
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            object-fit: cover !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        body{
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            object-fit: cover !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .arjs-loader {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .arjs-loader div {
            text-align: center;
            font-size: 1.25em;
            color: white;
            margin: 10px;
        }

        .arjs-loader .progress {
            font-size: 0.9em;
            color: #4CAF50;
        }

        .instructions {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 15px;
            font-family: Arial;
            font-size: 13px;
            z-index: 10000;
            border-radius: 5px;
            max-width: 90vw;
            display: none;
        }

        .instructions.show {
            display: block;
        }

        /* Coordinate Display Panel */
        .coordinates-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            z-index: 10001;
            border-radius: 8px;
            border: 2px solid #00ff00;
            min-width: 200px;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }

        .coordinates-panel h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #FFD700;
            text-align: center;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 5px;
        }

        .coord-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }

        .coord-label {
            color: #4CAF50;
            font-weight: bold;
        }

        .coord-value {
            color: #00ff00;
            font-weight: normal;
        }

        /* Control Buttons */
        .control-buttons {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 10001;
        }

        .control-btn {
            background: rgba(76, 175, 80, 0.9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }

        .control-btn:active {
            transform: scale(0.95);
            background: rgba(76, 175, 80, 1);
        }
    </style>
</head>

<body style="margin: 0px; overflow: hidden;">
    <!-- minimal loader shown until image descriptors are loaded -->
    <div class="arjs-loader">
        <div>üîÑ Loading NFT Marker...</div>
        <div class="progress">Please wait, this may take a moment</div>
    </div>

    <!-- Instructions overlay -->
    <div class="instructions" id="instructions">
        <strong>üì∏ Instructions:</strong><br>
        1. Point camera at your QR image<br>
        2. Keep the image in full view<br>
        3. Maracas will appear! üé∏<br>
        4. Use buttons to adjust position<br>
        <br>
        <span id="status">‚è≥ Waiting for marker...</span>
    </div>

    <!-- Coordinates Display Panel -->
    <div class="coordinates-panel" id="coordPanel">
        <h3>üìä Model Coordinates</h3>
        <div class="coord-item">
            <span class="coord-label">Position X:</span>
            <span class="coord-value" id="posX">0</span>
        </div>
        <div class="coord-item">
            <span class="coord-label">Position Y:</span>
            <span class="coord-value" id="posY">0</span>
        </div>
        <div class="coord-item">
            <span class="coord-label">Position Z:</span>
            <span class="coord-value" id="posZ">0</span>
        </div>
        <div class="coord-item">
            <span class="coord-label">Scale:</span>
            <span class="coord-value" id="scaleVal">0</span>
        </div>
        <div class="coord-item">
            <span class="coord-label">Rotation X:</span>
            <span class="coord-value" id="rotX">0</span>
        </div>
    </div>

    <!-- Control Buttons -->
    <div class="control-buttons">
        <button class="control-btn" id="btnScaleUp">üîç Scale +</button>
        <button class="control-btn" id="btnScaleDown">üîç Scale -</button>
        <button class="control-btn" id="btnMoveUp">‚¨ÜÔ∏è Y+</button>
        <button class="control-btn" id="btnMoveDown">‚¨áÔ∏è Y-</button>
        <button class="control-btn" id="btnMoveForward">‚û°Ô∏è Z+</button>
        <button class="control-btn" id="btnMoveBack">‚¨ÖÔ∏è Z-</button>
    </div>

    <!-- a-frame scene -->
    <a-scene
        vr-mode-ui="enabled: false;"
        renderer="logarithmicDepthBuffer: true;"
        embedded
        gesture-detector
        arjs="trackingMethod: best; sourceType: webcam;debugUIEnabled: false;"
    >
        <!-- a-nft is the anchor that defines an Image Tracking entity -->
        <!-- on 'url' use the path to the Image Descriptors created before -->
        <!-- the path should end with the name without the extension -->
        <a-nft
            markerhandler
            type="nft"
            url="./assets/images/maracas/maracas"
            smooth="true"
            smoothCount="10"
            smoothTolerance=".01"
            smoothThreshold="5"
        >
            <!-- Dragonite 3D Model -->
            <a-entity
                id="maracasModel"
                gltf-model="./assets/models/maracas/scene.gltf"
                scale="38 38 38"
                position="50 -50 90"
                rotation="-90 0 0"
                animation-mixer
                gesture-handler
            >
            </a-entity>

            <!-- Text Label -->
            <a-text
                value="MARACAS"
                align="center"
                color="#FFD700"
                scale="1 1 1"
                position="0 120 100"
            >
            </a-text>

            <!-- Optional: Add a platform/base -->
            <a-cylinder
                color="#4CAF50"
                height="3"
                radius="30"
                position="0 0 0"
                opacity="0.7"
            >
            </a-cylinder>
        </a-nft>
        
        <!-- static camera that moves according to the device movements -->
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // Register custom A-Frame component for marker handling
        AFRAME.registerComponent('markerhandler', {
            init: function() {
                const marker = this.el;
                
                // Marker found event
                marker.addEventListener('markerFound', () => {
                    console.log('‚úÖ Marker Found!');
                    
                    // Update status UI
                    const status = document.getElementById('status');
                    if (status) {
                        status.innerHTML = '<span style="color: #4CAF50;">‚úÖ Marker Found! Maracas is appearing...</span>';
                    }
                    
                    // You can add custom actions here, for example:
                    // - Play sound
                    // - Trigger animation
                    // - Show additional UI elements
                    // - Track analytics
                    
                    // Example: Get all entities in this marker
                    const entities = marker.querySelectorAll('a-entity');
                    entities.forEach(entity => {
                        // You can manipulate entities here
                        console.log('Entity found:', entity);
                    });
                });
                
                // Marker lost event
                marker.addEventListener('markerLost', () => {
                    console.log('‚ö†Ô∏è Marker Lost');
                    
                    // Update status UI
                    const status = document.getElementById('status');
                    if (status) {
                        status.innerHTML = '<span style="color: #ff9800;">‚ö†Ô∏è Marker Lost - Point camera back at the card</span>';
                    }
                    
                    // You can add custom actions here, for example:
                    // - Pause animations
                    // - Stop sounds
                    // - Hide UI elements
                });
            }
        });

        // Hide loader when NFT markers are loaded
        window.addEventListener('arjs-nft-loaded', function() {
            console.log('‚úÖ NFT Marker loaded successfully!');
            
            // Hide loader
            const loader = document.querySelector('.arjs-loader');
            if (loader) {
                loader.style.display = 'none';
            }

            // Show instructions
            const instructions = document.getElementById('instructions');
            if (instructions) {
                instructions.classList.add('show');
            }
        });

        // Optional: Track distance from marker
        window.addEventListener('load', () => {
            const camera = document.querySelector('[camera]');
            const marker = document.querySelector('a-nft');
            let distanceCheckInterval;

            if (marker && camera) {
                marker.addEventListener('markerFound', () => {
                    // Start tracking distance
                    distanceCheckInterval = setInterval(() => {
                        const cameraPosition = camera.object3D.position;
                        const markerPosition = marker.object3D.position;
                        const distance = cameraPosition.distanceTo(markerPosition);
                        
                        // Log distance (you can use this for custom logic)
                        console.log('Distance from marker:', distance.toFixed(2));
                        
                        // Example: Change model size based on distance
                        // const model = marker.querySelector('a-entity[gltf-model]');
                        // if (model && distance > 100) {
                        //     model.setAttribute('scale', '100 100 100');
                        // } else {
                        //     model.setAttribute('scale', '80 80 80');
                        // }
                    }, 500); // Check every 500ms
                });

                marker.addEventListener('markerLost', () => {
                    // Stop tracking distance
                    if (distanceCheckInterval) {
                        clearInterval(distanceCheckInterval);
                    }
                });
            }
        });

        // Fallback: hide loader after 10 seconds if event doesn't fire
        setTimeout(function() {
            const loader = document.querySelector('.arjs-loader');
            if (loader && loader.style.display !== 'none') {
                console.log('‚ö†Ô∏è Loader timeout - hiding anyway');
                loader.style.display = 'none';
                
                const instructions = document.getElementById('instructions');
                if (instructions) {
                    instructions.classList.add('show');
                }
            }
        }, 10000);

        // Log scene loaded
        const scene = document.querySelector('a-scene');
        if (scene) {
            scene.addEventListener('loaded', function() {
                console.log('üé¨ A-Frame scene loaded');
                
                // Initialize controls after scene is loaded
                initializeControls();
            });
        }

        // Initialize control buttons and coordinate tracking
        function initializeControls() {
            const model = document.getElementById('maracasModel');
            if (!model) {
                console.error('Model not found!');
                return;
            }

            // Get current position, scale, rotation
            let currentPos = { x: 0, y: -50, z: -50 };
            let currentScale = 0.1;
            let currentRot = { x: -90, y: 0, z: 0 };

            // Update coordinate display
            function updateCoordinateDisplay() {
                document.getElementById('posX').textContent = currentPos.x.toFixed(2);
                document.getElementById('posY').textContent = currentPos.y.toFixed(2);
                document.getElementById('posZ').textContent = currentPos.z.toFixed(2);
                document.getElementById('scaleVal').textContent = currentScale.toFixed(3);
                document.getElementById('rotX').textContent = currentRot.x.toFixed(0);
            }

            // Apply changes to model
            function applyChanges() {
                model.setAttribute('position', `${currentPos.x} ${currentPos.y} ${currentPos.z}`);
                model.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`);
                updateCoordinateDisplay();
                
                // Log to console for easy copy-paste
                console.log(`üìä Current Settings:
                    position="${currentPos.x} ${currentPos.y} ${currentPos.z}"
                    scale="${currentScale} ${currentScale} ${currentScale}"
                    rotation="${currentRot.x} ${currentRot.y} ${currentRot.z}"`);
            }

            // Button event listeners
            document.getElementById('btnScaleUp').addEventListener('click', () => {
                currentScale += 0.01;
                applyChanges();
            });

            document.getElementById('btnScaleDown').addEventListener('click', () => {
                currentScale = Math.max(0.01, currentScale - 0.01);
                applyChanges();
            });

            document.getElementById('btnMoveUp').addEventListener('click', () => {
                currentPos.y += 5;
                applyChanges();
            });

            document.getElementById('btnMoveDown').addEventListener('click', () => {
                currentPos.y -= 5;
                applyChanges();
            });

            document.getElementById('btnMoveForward').addEventListener('click', () => {
                currentPos.z += 5;
                applyChanges();
            });

            document.getElementById('btnMoveBack').addEventListener('click', () => {
                currentPos.z -= 5;
                applyChanges();
            });

            // Real-time coordinate tracking
            setInterval(() => {
                const position = model.getAttribute('position');
                const scale = model.getAttribute('scale');
                const rotation = model.getAttribute('rotation');
                
                if (position) {
                    currentPos = { x: position.x, y: position.y, z: position.z };
                }
                if (scale) {
                    currentScale = scale.x;
                }
                if (rotation) {
                    currentRot = { x: rotation.x, y: rotation.y, z: rotation.z };
                }
                
                updateCoordinateDisplay();
            }, 100); // Update every 100ms

            // Initial display
            updateCoordinateDisplay();
        }

        // Add gesture controls component (pinch to zoom)
        AFRAME.registerComponent('gesture-handler', {
            schema: {
                enabled: { default: true },
                rotationFactor: { default: 5 },
                minScale: { default: 0.01 },
                maxScale: { default: 10 },
            },
            init: function () {
                this.handleScale = this.handleScale.bind(this);
                this.handleRotation = this.handleRotation.bind(this);

                this.isVisible = false;
                this.initialScale = this.el.object3D.scale.clone();
                this.scaleFactor = 1;

                this.el.sceneEl.addEventListener('markerFound', (e) => {
                    this.isVisible = true;
                });

                this.el.sceneEl.addEventListener('markerLost', (e) => {
                    this.isVisible = false;
                });
            },
            update: function () {
                if (this.data.enabled) {
                    this.el.sceneEl.addEventListener('onefingermove', this.handleRotation);
                    this.el.sceneEl.addEventListener('twofingermove', this.handleScale);
                }
            },
            remove: function () {
                this.el.sceneEl.removeEventListener('onefingermove', this.handleRotation);
                this.el.sceneEl.removeEventListener('twofingermove', this.handleScale);
            },
            handleRotation: function (event) {
                if (this.isVisible) {
                    this.el.object3D.rotation.y += event.detail.positionChange.x * this.data.rotationFactor;
                    this.el.object3D.rotation.x += event.detail.positionChange.y * this.data.rotationFactor;
                }
            },
            handleScale: function (event) {
                if (this.isVisible) {
                    this.scaleFactor *= 1 + event.detail.spreadChange / event.detail.startSpread;
                    this.scaleFactor = Math.min(Math.max(this.scaleFactor, this.data.minScale), this.data.maxScale);

                    this.el.object3D.scale.x = this.scaleFactor * this.initialScale.x;
                    this.el.object3D.scale.y = this.scaleFactor * this.initialScale.y;
                    this.el.object3D.scale.z = this.scaleFactor * this.initialScale.z;
                }
            },
        });
    </script>
</body>
</html>
